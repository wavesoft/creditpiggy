/*! CreditPiggy API v0.1 | Ioannis Charalampidis, Citizen Cyberlab EU Project | GNU GPL v2.0 License */
(window.define==undefined?function(b,a){window.CreditPiggy=a($||jQuery)}:window.define)(["jquery"],function(a){if(!a){console.error("CreditPiggy: jQuery must loaded prior to creditpiggy.js!");return null}var b={version:"0.1",baseURL:"//creditpiggy.cern.ch",session:null,profile:null,__callbacks:{},__initialised:false,__cryptokey:null,__claimedWorkers:[],__webid:null};b.__same=function(d,c){if((d==undefined)&&(c==undefined)){return true}if((d==undefined)||(c==undefined)){return false}for(var e in d){if(d.hasOwnProperty(e)){if(c.hasOwnProperty(e)){if(typeof(d[e])!=typeof(c[e])){return false}if(typeof(d[e])=="object"){if(!this.__same(d[e],c[e])){return false}}if(d[e]!=c[e]){return false}}else{return false}}}for(var e in c){if(c.hasOwnProperty(e)&&!d.hasOwnProperty(e)){return false}}return true};b.__popup=function(e){var d=770,g=470,c=(screen.width-d)/2,f=(screen.height-g)/2;if(this.loginWindow){this.loginWindow.close()}this.loginWindow=window.open(e,"creditpiggy-popup-window","width="+d+",height="+g+",left="+c+",top="+f+",location=no,menubar=no,resizable=yes,scrollbars=yes,status=no,toolbar=no")};b.__api=function(d,c,e){var c=c||{};c.version=this.version;c.webid=this.__webid;a.ajax({url:this.baseURL+"/api/"+d+".jsonp",dataType:"jsonp",data:c,method:"GET"}).done((function(g,h,f){if(e){e(g)}}).bind(this)).fail((function(f,h,g){if(e){e(null,h)}}).bind(this))};b.__applySessionChanges=function(c){var d=this.profile;if((!this.session||!this.session.profile)&&c&&c.profile){this.profile=c.profile;a(this).triggerHandler("login",[c.profile])}else{if((!c||!c.profile)&&(this.session&&this.session.profile)){a(this).triggerHandler("logout",[this.session.profile]);this.profile=null}}if(c&&c.profile){if(!this.__same(c.profile,d)){this.profile=c.profile;a(this).triggerHandler("profile",[c.profile])}}if(c&&c.cryptokey){this.__cryptokey=c.cryptokey}this.session=c};b.__updateSession=function(){this.__api("lib/session",{},(function(c){if(!c){console.warn("CreditPiggy: Unable to obtain session information");this.session=null;return}this.__applySessionChanges(c)}).bind(this))};b.__initialize=function(){if(this.__initialised){return}this.__updateSession();this.__initialised=true};b.__checkSession=function(c){if(this.profile){if(c){c(true)}}else{if(c){c(false)}}};b.configure=function(c){this.__webid=c;if(!this.__initialised){this.__initialize()}else{this.__updateSession()}};b.logout=function(){if(!this.session||!this.session.profile){return false}this.__api("lib/logout");return true};b.showLogin=function(){if(this.session&&this.session.profile){return false}this.__popup(this.baseURL+"/login/?webid="+escape(this.__webid));return true};b.showProfile=function(){if(!this.session||!this.session.profile){return false}this.__popup(this.baseURL+"/profile/?webid="+escape(this.__webid));return true};b.claimWorker=function(c,d){this.__checkSession((function(e){if(!e){if(d){d(false,"You are not logged in!")}}else{this.__api("lib/claim",{vmid:c},(function(f){if(!d){return}if(!f){d(false,"Unable to handle your request")}else{if(f.result!="ok"){d(false,f.error)}else{d(true)}}}).bind(this))}}).bind(this))};b.releaseWorker=function(c,d){this.__checkSession((function(e){if(!e){if(d){d(false,"You are not logged in!")}}else{this.__api("lib/release",{vmid:c},(function(f){if(!d){return}if(!f){d(false,"Unable to handle your request")}else{if(f.result!="ok"){d(false,f.error)}else{d(true)}}}).bind(this))}}).bind(this))};b.thawSession=function(c,d){if(!c){return}this.__api("lib/thaw",{token:c},(function(e){if(!d){return}if(!e){d(false,"Unable to handle your request")}else{if(e.result!="ok"){d(false,e.error)}else{this.__applySessionChanges(e);d(e.auth_token)}}}).bind(this))};b.freezeSession=function(){if(!this.session){return""}else{return this.session.auth_token}};a((function(){if(!this.__webid){return}this.__initialize()}).bind(b));a(window).on("focus",(function(c){this.__updateSession()}).bind(b));a(window).on("message",(function(c){var f=c.originalEvent;if(String(f.origin).indexOf(this.baseURL)==-1){console.warn("CreditPiggy: Discarding incoming message from untrusted origin");return}var d;try{d=JSON.parse(f.data)}catch(f){console.warn("CreditPiggy: Invalid message received");return}if(d.action=="session"){this.__applySessionChanges(d.session)}else{if(d.action=="logout"){this.__applySessionChanges(null)}}}).bind(b));return b});