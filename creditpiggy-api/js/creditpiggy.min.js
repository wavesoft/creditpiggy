/*! CreditPiggy API v0.1 | Ioannis Charalampidis, Citizen Cyberlab EU Project | GNU GPL v2.0 License */
(window.define==undefined?function(b,a){window.CreditPiggy=a($||jQuery)}:window.define)(["jquery"],function(a){if(!a){console.error("CreditPiggy: jQuery must available in order to use creditpiggy.js!");return null}var b={version:"0.1",baseURL:"http://127.0.0.1:8000",project:null,session:null,profile:null,__callbacks:{},__initialised:false};b.__popup=function(e){var d=770,g=470,c=(screen.width-d)/2,f=(screen.height-g)/2;if(this.loginWindow){this.loginWindow.close()}this.loginWindow=window.open(e,"creditpiggy-popup-window","width="+d+",height="+g+",left="+c+",top="+f+",location=no,menubar=no,resizable=yes,scrollbars=yes,status=no,toolbar=no")};b.__api=function(d,c,e){a.ajax({url:this.baseURL+"/api/"+d+".jsonp",dataType:"jsonp",data:c||{version:this.version},method:"GET"}).done((function(g,h,f){if(e){e(g)}}).bind(this)).fail((function(f,h,g){if(e){e(null,h)}}).bind(this))};b.__applySessionChanges=function(c){if((!this.session||!this.session.profile)&&c.profile){a(this).triggerHandler("login",[c.profile])}else{if((!c||!c.profile)&&(this.session&&this.session.profile)){a(this).triggerHandler("logout",[this.session.profile])}}if(c.profile){a(this).triggerHandler("profile",[c.profile])}this.session=c};b.__updateSession=function(){this.__api("lib/session",{project:this.project},(function(c){if(!c){console.warn("CreditPiggy: Unable to obtain session information");this.session=null;return}this.__applySessionChanges(c)}).bind(this))};b.__initialize=function(){if(this.__initialised){return}this.__updateSession();this.__initialised=true};b.configure=function(c){if(c.project){this.project=c.project}if(!this.__initialised){this.__initialize()}else{this.__updateSession()}};b.showLogin=function(){if(this.session&&this.session.profile){return false}this.__popup(this.baseURL+"/login/?project="+escape(this.project));return true};b.showProfile=function(){if(!this.session||!this.session.profile){return false}this.__popup(this.baseURL+"/profile/?project="+escape(this.project));return true};b.showProject=function(){this.__popup(this.baseURL+"/project/"+this.project+"/");return true};a((function(){if(!this.project){return}this.__initialize()}).bind(b));a(window).on("message",(function(c){var f=c.originalEvent;if(String(f.origin).indexOf(this.baseURL)==-1){console.warn("CreditPiggy: Discarding incoming message from untrusted origin");return}try{var d=JSON.parse(f.data);if(d.action=="session"){this.__applySessionChanges(d.session)}else{if(d.action=="logout"){this.__applySessionChanges(null)}}}catch(f){console.warn("CreditPiggy: Invalid message received");return}}).bind(b));return b});