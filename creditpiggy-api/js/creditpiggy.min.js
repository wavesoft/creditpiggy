/*! CreditPiggy API v0.1 | Ioannis Charalampidis, Citizen Cyberlab EU Project | GNU GPL v2.0 License */
(window.define==undefined?function(b,a){window.CreditPiggy=a($||jQuery)}:window.define)(["jquery"],function(c){if(!c){console.error("CreditPiggy: jQuery must loaded prior to creditpiggy.js!");return null}var d={version:"0.2",baseURL:"//creditpiggy.cern.ch",session:null,profile:null,__initialised:false,__cryptokey:null,__claimedWorkers:[],__embedObjects:[],__webid:null,__oneTimeInitEnabled:false,__pollingTimer:null};var a=function(f,e){if((f==undefined)&&(e==undefined)){return true}if((f==undefined)||(e==undefined)){return false}for(var g in f){if(f.hasOwnProperty(g)){if(e.hasOwnProperty(g)){if(typeof(f[g])!=typeof(e[g])){return false}if(typeof(f[g])=="object"){if(!a(f[g],e[g])){return false}}if(f[g]!=e[g]){return false}}else{return false}}}for(var g in e){if(e.hasOwnProperty(g)&&!f.hasOwnProperty(g)){return false}}return true};var b=null;d.__thawFirst=function(g){var f=jQuery._data(this,"events")["thaw"];if(!f||!f.length){g();return}b=(function(h){if(!h){g()}else{this.session=null}}).bind(this);var e=null;if(this.session&&this.session.auth_token){e=this.session["this.session"]}c(this).triggerHandler("thaw",[e])};d.__popup=function(g){var f=770,j=470,e=(screen.width-f)/2,i=(screen.height-j)/2;if(this.loginWindow){this.loginWindow.close()}this.loginWindow=window.open(g,"creditpiggy-popup-window","width="+f+",height="+j+",left="+e+",top="+i+",location=no,menubar=no,resizable=yes,scrollbars=yes,status=no,toolbar=no")};d.__api=function(f,e,g){var e=e||{};e.version=this.version;e.webid=this.__webid;c.ajax({url:this.baseURL+"/api/"+f+".jsonp",dataType:"jsonp",data:e,method:"GET"}).done((function(i,j,h){if(g){g(i)}}).bind(this)).fail((function(h,j,i){if(g){g(null,j)}}).bind(this))};d.__applySessionChanges=function(h,j,i){var k=this.profile,g=this.session,j=!!j;this.session=h;var e=(function(){if(i){this.__thawFirst(f)}else{f()}}).bind(this),f=(function(){if((!g||!g.profile)&&h&&h.profile){this.profile=h.profile;c(this).triggerHandler("login",[h.profile,j]);this.__reloadEmbeds();var l=String(window.location);if(l.indexOf("cpr=")>=0){var n=l.split("cpr=")[1].substr(0,8);if(n[7]!="."){console.warn("Invalid referrer tracking information identified in the URL")}else{this.__api("lib/referrer",{ref:n.substr(0,7)})}}}else{if((!h||!h.profile)&&(g&&g.profile)){c(this).triggerHandler("logout",[g.profile,j]);this.profile=null;this.__reloadEmbeds()}}if(h&&h.profile){if(!a(h.profile,k)){this.profile=h.profile;c(this).triggerHandler("profile",[h.profile]);if(this.profile.ref!==undefined){var m="cpr="+this.profile.ref+".";c(this).triggerHandler("referrer",[m,this.profile.ref])}}}if(!g&&!h){}else{if(g&&!h){c(this).triggerHandler("token",[null,j])}else{if(((!g&&h)||(g.auth_token!=h.auth_token))&&h.auth_token){c(this).triggerHandler("token",[h.auth_token||null,j])}}}if(h&&h.cryptokey){this.__cryptokey=h.cryptokey}}).bind(this);e()};d.__reloadEmbeds=function(h){for(var f=0;f<this.__embedObjects.length;f++){var g=this.__embedObjects[f];g.attr("src",g.attr("src"))}};d.__updateSession=function(e){this.__api("lib/session",{},(function(f){if(!f){console.warn("CreditPiggy: Unable to obtain session information");this.session=null;return}if(!e&&(!this.session||!this.session.profile)){e=this.__oneTimeInitEnabled;this.__oneTimeInitEnabled=false}this.__applySessionChanges(f,false,e)}).bind(this));this.__reloadEmbeds()};d.__initialize=function(){if(this.__initialised){return}this.__scheduleUpdate(true);this.__initialised=true};d.__checkSession=function(e){if(this.profile){if(e){e(true)}}else{if(e){e(false)}}};d.__scheduleUpdate=function(e){clearTimeout(d.__pollingTimer);this.__updateSession(e===true);d.__pollingTimer=setTimeout(d.__scheduleUpdate.bind(this),60000)};d.configure=function(f,e){this.__webid=f;if(e){this.baseURL=e}if(!this.__initialised){this.__initialize()}else{this.__scheduleUpdate(true)}};d.logout=function(){if(!this.session||!this.session.profile){return false}this.__api("lib/logout");return true};d.showLogin=function(){if(this.session&&this.session.profile){return false}this.__popup(this.baseURL+"/login/?webid="+escape(this.__webid));return true};d.showProfile=function(){if(!this.session||!this.session.profile){return false}this.__popup(this.baseURL+"/profile/?webid="+escape(this.__webid));return true};d.showWebsiteStatus=function(){this.__popup(this.baseURL+"/website/?webid="+escape(this.__webid));return true};d.claimWorker=function(e,f){this.__checkSession((function(g){if(!g){if(f){f(false,"You are not logged in!")}}else{this.__api("lib/claim",{vmid:e},(function(h){if(!f){return}if(!h){f(false,"Unable to handle your request")}else{if(h.result!="ok"){f(false,h.error)}else{f(true)}}}).bind(this))}}).bind(this))};d.releaseWorker=function(e,f){this.__checkSession((function(g){if(!g){if(f){f(false,"You are not logged in!")}}else{this.__api("lib/release",{vmid:e},(function(h){if(!f){return}if(!h){f(false,"Unable to handle your request")}else{if(h.result!="ok"){f(false,h.error)}else{f(true)}}}).bind(this))}}).bind(this))};d.thawSession=function(e,f){if(!e){if(b){b(false);b=null}return}this.__api("lib/thaw",{token:e},(function(g){if(!g){if(b){b(false);b=null}if(f){f(false,"Unable to handle your request")}}else{if(b){b((g.result=="ok"));b=null}if(g.result!="ok"){if(f){f(false,g.error)}}else{this.__applySessionChanges(g);if(f){f(g.auth_token)}}}}).bind(this))};d.createEmbed=function(f,e){if(!e){e=c('<div class="creditpiggy-embed-container"></div>')}var g=c('<iframe frameborder="0" class="creditpiggy-embed-iframe"></iframe>').attr("src",this.baseURL+"/embed/"+f+"/?webid="+escape(this.__webid)).appendTo(e);this.__embedObjects.push(g);return e};c((function(){if(!this.__webid){return}this.__initialize()}).bind(d));c(window).on("focus",(function(e){this.__scheduleUpdate()}).bind(d));c(window).on("blur",(function(e){this.__oneTimeInitEnabled=true;clearTimeout(this.__pollingTimer)}).bind(d));c(window).on("message",(function(f){var h=f.originalEvent;if(String(h.origin).indexOf(this.baseURL)==-1){console.warn("CreditPiggy: Discarding incoming message from untrusted origin");return}var g;try{g=JSON.parse(h.data)}catch(h){console.warn("CreditPiggy: Invalid message received");return}if(g.action=="session"){this.__applySessionChanges(g.session,true)}else{if(g.action=="logout"){this.__applySessionChanges(null,true)}}}).bind(d));return d});